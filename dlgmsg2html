#!/bin/bash
#
# $Id: dlgmsg2html,v 1.2 2004-03-27 22:49:25 psy Exp $
#
# This shell script parses DLG (Dialog) messages and produces HTML pages.

echo Processing $1... 1>&2

FROM=`head -1 $1 | cut -c12-43 | sed -e 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g'`
TO=`head -2 $1 | tail -1 | cut -c12-43 | sed -e 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g'`
DATE=`head -3 $1 | tail -1 | cut -c12- | sed -e 's/ 93 / 1993 /'`
SUBJECT=`head -4 $1 | tail -1 | cut -c12- | sed -e 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g'`
MSG=`head -1 $1 | sed -e 's/^.*MSG //;s/ OF.*//'`

if fgrep '[Reply To' $1 >&/dev/null
then
    REF=`head -2 $1 | tail -1 | sed -e 's/^.*Reply To //;s/\].*//'`
    REF_FROM=`head -1 $PREFIX$REF | cut -c12-43 | sed -e 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g'`
    REF_SUBJECT=`head -4 $PREFIX$REF | tail -1 | cut -c12- | sed -e 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g'`
fi

if fgrep '[Has Reply' $1 >&/dev/null
then
    REPLY=`head -2 $1 | tail -1 | sed -e 's/^.*Has Reply //;s/\].*//'`
    REPLY_FROM=`head -1 $PREFIX$REPLY | cut -c12-43 | sed -e 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g'`
    REPLY_SUBJECT=`head -4 $PREFIX$REPLY | tail -1 | cut -c12- | sed -e 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g'`
fi

if [ $MSG -lt $LAST_MSG ]
then
    NEXT=`ls -1 $PREFIX* | sort -n -k 1.4 | grep "^$PREFIX$MSG\$" -A 1 | tail -1 | cut -c4-`
    NEXT_FROM=`head -1 $PREFIX$NEXT | cut -c12-43 | sed -e 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g'`
    NEXT_SUBJECT=`head -4 $PREFIX$NEXT | tail -1 | cut -c12- | sed -e 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g'`
fi

if [ $MSG -gt $FIRST_MSG ]
then
    PREV=`ls -1 $PREFIX* | sort -n -k 1.4 | grep "^$PREFIX$MSG\$" -B 1 | head -1 | cut -c4-`
    PREV_FROM=`head -1 $PREFIX$PREV | cut -c12-43 | sed -e 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g'`
    PREV_SUBJECT=`head -4 $PREFIX$PREV | tail -1 | cut -c12- | sed -e 's/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g'`
fi

cat <<EOF
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />
    <title>$TITLE: $SUBJECT</title>
    <link rel="Start" href="index.html" />
    <link rel="Top" href="index.html" />
    <link rel="Up" href="index.html" />
    <link rel="Contents" href="index.html" />
    <link rel="First" href="$PREFIX$FIRST_MSG.html" />  
    <link rel="Index" href="index_date.html" />  
    <link rel="Last" href="$PREFIX$LAST_MSG.html" />  
EOF
if [ $MSG -lt $LAST_MSG ]
then
    cat <<EOF
    <link rel="Next" href="$PREFIX$NEXT.html" />  
EOF
fi
if [ $MSG -gt $FIRST_MSG ]
then
    cat <<EOF
    <link rel="Prev" href="$PREFIX$PREV.html" />  
EOF
fi
cat <<EOF
    <style type="text/css">
      <!--
	th {text-align: right}
      -->
    </style>
  </head>
  <body>
    <h1>$SUBJECT</h1>
    <table>
      <tr><th>From:</th><td>$FROM</td></tr>
      <tr><th>To:</th><td>$TO</td></tr>
      <tr><th>Date:</th><td>$DATE</td></tr>
    </table>
    <table style="padding-left: 3em; font-size: smaller">
EOF
if [ $MSG -lt $LAST_MSG ]
then
    cat <<EOF
      <tr><th>Next message:</th><td><a href="$PREFIX$NEXT.html">$NEXT_FROM: $NEXT_SUBJECT</a></td></tr>
EOF
fi
if [ $MSG -gt $FIRST_MSG ]
then
    cat <<EOF
      <tr><th>Previous message:</th><td><a href="$PREFIX$PREV.html">$PREV_FROM: $PREV_SUBJECT</a></td></tr>
EOF
fi
if [ $REF ]
then
    cat <<EOF
      <tr><th>In reply to:</th><td><a href="$PREFIX$REF.html">$REF_FROM: $REF_SUBJECT</a></td></tr>
EOF
fi
if [ $REPLY ]
then
    cat <<EOF
      <tr><th>Reply:</th><td><a href="$PREFIX$REPLY.html">$REPLY_FROM: $REPLY_SUBJECT</a></td></tr>
EOF
fi
cat <<EOF
      <tr><th>Messages sorted by:</th><td>[&nbsp;<a
	    href="index_date.html">date</a>&nbsp;] [&nbsp;<a
	    href="index_subject.html">subject</a>&nbsp;] [&nbsp;<a
	    href="index_author.html">author</a>&nbsp;]</td></tr>
    </table>
    <hr />
<pre>
EOF
sed '1,5d;s/&/\&amp;/g;s/</\&lt;/g;s/>/\&gt;/g' $1
cat <<EOF
</pre>
    <hr />
    <p>Generated by <a style="font-size: smaller" href="http://www.nothingisreal.com/dlg2html/">dlg2html 1.0</a></p>
  </body>
</html>
EOF
